# The troubles with Python 3.13, Kubernetes and Vault...

The newly - as of 3.13 - defaulted SSL behavior requiring `VERIFY_X509_STRICT` breaks both the Python Kubernetes client and Vault over SSL functionality.

## Kubernetes (microk8s 1.32.3)

The default CA Certificate generated for the cluster does not assert the `keyUsage=critical,digitalSignature,keyCertSign` attribute which causes any Python-kubernetes API calls to fails (rather spectacularly, by the way).  It is relatively straight forward to address right after you install the microk8s snap, slightly more convoluted if you already have a multi-node cluster running.  The short version is:

```
cd /var/snap/microk8s/current/certs
mkdir cadir
openssl genrsa -out cadir/ca.key 2048
openssl req -x509 -new -nodes -key ca.key -sha256 -days 360 -out cadir/ca.crt -addext "keyUsage=critical,digitalSignature,keyCertSign"
microk8s refresh-certs cadir [Original Post](https://github.com/canonical/microk8s/issues/4864)
```

If you're modifying an existing cluster, you'll have to tear it all down:

- Designate one node to be the 'prime'

- For each of the other nodes:

    - kubectl taint nodes <node1> <node2> key=value:NoSchedule

    - kubectl drain lboost cboost --ignore-daemonsets --delete-emptydir-data

    - microk8s leave

- microk8s remove-node <node1>
  microk8s remove-node <node2>

- run the code above

- microk8s stop && microk8s start

- microk8s add-node (for each of the nodes)

## Vault (1.19.4)

For vault, there are two issues:

1. Python 3.13 has the same requirements here as well, so you need an RFC 5280 compliant CA Cert (exactly as above) to make Python happy, and

2. Vault authentication requires that your Vault TLS Certificate has _at least one_ IP-based SAN [1] (Subject Alternative Name, see RFC 2818)
mine _now_looks like this:
```
X509v3 Subject Alternative Name:
    IP Address:192.168.86.60, IP Address:127.0.0.1
```
Which I generated by creating an openssl.cnf:
```
[ v3_req ]
keyUsage = critical, digitalSignature, keyEncipherment
subjectAltName = IP:192.168.86.60, IP:127.0.0.1
```
and running:
```
openssl genpkey -algorithm RSA -out vault.key
openssl req -new -key vault.key -out vault.csr -subj "/CN=vault-server" -addext "subjectAltName=IP:192.168.86.60,IP:127.0.0.1,DNS:vault.local"
openssl x509 -req -in vault.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out vault.crt -days 365 -sha256 -extfile openssl.cnf -extensions v3_req
```
and verified with:
```
openssl x509 -in vault.crt -text -noout
```

## Shorcut???

I streamlined my process a bit by updating the microk8s CA cert and key, and then using that new CA cert to generate my vault cert and key so I only needed a single new RFC 5280 compliant CA. By doing this I have attempted to avoid multiple CAs, and ensure compliance across my services.
Good idea - we'll see, but it is working fine.

[1]: OK, my ignorance had me thinking I needed an IP-based Storage Area Network - what a NOOB<smh/>